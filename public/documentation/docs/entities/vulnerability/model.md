# Модель данных

## Описание сущности

Данная модель данных описывает представление уязвимости в концепции ASOC платформы.

**Не путать это описание с форматом хранения в хранилищах сервисов**

### Критерии для построения модели:

1. Типизация

Модель должна содержать ровно те поля, которые требуются для описания уязвимости.
Требуется избегать "мета" полей, которые со времени могут превратиться в помойку всех данных, которые
не попали под основное описание.

2. Расширяемость

Модель должна иметь возможность масштабирования, по мере развития платоформы, ядер будут добавляться новые типы проверок, 
результатов.
Добавление новых вводных не должно негативно сказываться на расширяемость модели.

3. Обратная совместимость при обновлении или при частичном обновлении

### Общая концепция

1. "Базовая" сущность

В качестве основы протокола взято поле `result` из протокола sarif.

Были добавлены некоторые новые поля в модель и убраны, те которые не планируются использоваться.

Также, значения некоторых полей переработаны, и носят другую смысловую нагрузку в отличие от описанной в спецификации.

Описание полей см. ниже.

2. Расширяемость модели

Спецификация sarif содержит такое поле как `property`, которое может включать в себя любые данные специфические для анализатора, но, которые не укладываются в sarif.

Упаковывать все не форматные данные в одно свойство плохая идея: сложнее парсинг, слабая типизация.

Любой следующий формат нового типа уязвимости не укладывающийся в sarif будет представляем своим полем (на одном уровне с полями uuid, locations)

## Описание модели

### Схема модели уязвимости


![Документ](@document/asoc.entities.vulnerability.model.schema)


### Описание полей

* ruleId: string

Идентификатор типа уязвимости.

* uuid: string

Уникальный идентификатор **найденной** уязвимости в процессе сканирования.

Применяется для идентификации конкретной уязвимости, например, для обогащения, дедупликации.

* rank: int

Уровень угрозы уязвимости, вычисляется сканирующим ядром. Уровень угрозы зависит от контекста, где была найдена уязвимость.

Следующие поля трактуются согласно спецификации `sarif`:

* analysisTarget: ArtifactLocation
* webRequest: WebRequest
* webResponse: WebResponse
* locations: []Location
* codeFlows: []CodeFlows

Расширение модели производится добавлением новых полей на этом уровне.
Новый тип поля должен содержат набор полей необходимый для содержания всех необходимых данных для информации об уязвимости:

* CUSTOM: NEW_TYPES

**ПРИМЕР:** Поле `enumarate` в примере ниже

При таком подходе остается возможность представлять любую уязвимость одной моделью (одной структурой/классом)


## Примеры модели с данными

### SAST + DAST + enumarate


```json
{
  "level": "error",
  "ruleId": "vuln_id",
  "locations": [
    {
      "physicalLocation": {
        "artifactLocation": {
          "uri": "file:///c:/Work/pt-jsa/Modules/JSA.JavaScript/Tests/Assets/Func/JSA.JavaScript.VulnersTests/external/dvna/core/appHandler.js",
          "description": {
            "text": "db.sequelize.query(query, {\r\n    model: db.User,\r\n})"
          }
        },
        "region": {
          "startLine": 11,
          "startColumn": 3,
          "endLine": 14,
          "endColumn": 7,
          "snippet": {
            "text": "db.sequelize.query(query, {\r\n    model: db.User,\r\n})"
          }
        }
      }
    },
    {
      "physicalLocation": {
        "artifactLocation": {
          "uri": "https://127.0.0.1:8080/greeting?name=%3C%2Fp%3E%3Cscript%3Ealert%281%29%3B%3C%2Fscript%3E%3Cp%3E"
        },
        "region": {
          "startLine": 10,
          "snippet": {
            "text": "</p><script>alert(1);</script><p>"
          }
        }
      },
      "properties": {
        "attack": "</p><script>alert(1);</script><p>"
      }
    }
  ],
  "codeFlows": [
    {
      "threadFlows": [
        {
          "locations": [
            {
              "location": {
                "physicalLocation": {
                  "artifactLocation": {
                    "uri": "file:///c:/Work/pt-jsa/Modules/JSA.JavaScript/Tests/Assets/Func/JSA.JavaScript.VulnersTests/external/dvna/core/appHandler.js"
                  },
                  "region": {
                    "startLine": 11,
                    "startColumn": 3,
                    "endLine": 14,
                    "endColumn": 7,
                    "snippet": {
                      "text": "db.sequelize.query(query, {\r\n    model: db.User,\r\n})"
                    }
                  }
                }
              },
              "module": "module",
              "nestingLevel": 1
            }
          ]
        }
      ]
    }
  ],
  "properties": {
    "Type": "SQL Injection",
    "IsSuspected": false,
    "IsSecondOrder": false,
    "IsSuppressed": false,
    "Exploit": {
      "Type": "HTTP",
      "Text": "POST /app/usersearch? HTTP/1.1\r\nHost: localhost\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 0\r\n\r\nlogin=sleep(5)\r\n\r\n",
      "Parameters": []
    },
    "AdditionalConditions": "((!! request.isAuthenticated()) === true)",
    "EntryPoint": {
      "artifactLocation": {
        "uri": "file:///c:/Work/pt-jsa/Modules/JSA.JavaScript/Tests/Assets/Func/JSA.JavaScript.VulnersTests/external/dvna/server.js"
      },
      "region": {
        "startLine": 42,
        "startColumn": 1,
        "endLine": 42,
        "endColumn": 39,
        "snippet": {
          "text": "app.listen(config.port, config.listen)"
        }
      }
    },
    "TaintDataEntries": [
      {
        "artifactLocation": {
          "uri": "file:///c:/Work/pt-jsa/Modules/JSA.JavaScript/Tests/Assets/Func/JSA.JavaScript.VulnersTests/external/dvna/core/appHandler.js"
        },
        "region": {
          "startLine": 10,
          "startColumn": 59,
          "endLine": 10,
          "endColumn": 67,
          "snippet": {
            "text": "req.body"
          }
        }
      }
    ]
  },
  "webRequest": {
    "protocol": "HTTP",
    "version": "1.1",
    "target": "https://127.0.0.1:8080/greeting?name=%3C%2Fp%3E%3Cscript%3Ealert%281%29%3B%3C%2Fscript%3E%3Cp%3E",
    "method": "GET",
    "headers": {
      "Cache-Control": "no-cache",
      "Content-Length": "0",
      "Cookie": "JSESSIONID=38AA1F7A61982DF1073D7F43A3707798; locale=de",
      "Host": "127.0.0.1:8080",
      "Pragma": "no-cache",
      "Referer": "https://127.0.0.1:8080/hello",
      "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:92.0) Gecko/20100101 Firefox/92.0"
    },
    "body": {}
  },
  "webResponse": {
    "statusCode": 200,
    "reasonPhrase": "",
    "protocol": "HTTP",
    "version": "1.1",
    "headers": {
      "Cache-Control": "no-cache, no-store, max-age=0, must-revalidate",
      "Content-Language": "en-US",
      "Content-Security-Policy": "script-src 'self'",
      "Content-Type": "text/html;charset=UTF-8",
      "Date": "Thu, 11 Nov 2021 09:56:20 GMT",
      "Expires": "0",
      "Pragma": "no-cache",
      "Referrer-Policy": "no-referrer",
      "Set-Cookie": "locale=de; HttpOnly; SameSite=strict",
      "Strict-Transport-Security": "max-age=31536000 ; includeSubDomains",
      "X-Content-Type-Options": "nosniff",
      "X-Frame-Options": "DENY",
      "X-XSS-Protection": "1; mode=block"
    }
  },
  "enumarate": {
    "subdomains": {
      "subdomain.example.com": [
        "1.1.1.1",
        "1.0.0.1"
      ]
    },
    "ports": {
      "1.1.1.1": [
        8080,
        443
      ]
    },
    "origins": [
      "http://subdomain.example.com:8080",
      "https://subdomain.example.com"
    ]
  }
}
```
